window.ocrPlugin=new class{constructor(){this.currentImageData=null,this.currentText="",this.isProcessing=!1,this.init()}init(){this.bindEvents(),this.initializePage()}bindEvents(){document.addEventListener("DOMContentLoaded",()=>{this.checkElements(),this.testStatusUpdate()}),setInterval(()=>this.updateTimestamp(),1e3)}initializePage(){this.hideLoading(),this.showImagePlaceholder(),this.resetTextContent(),this.clearErrorMessages(),this.updateStatus("Ready")}checkElements(){document.getElementById("statusText"),document.getElementById("timestamp")}testStatusUpdate(){setTimeout(()=>{this.updateStatus("Page loaded successfully")},1e3)}getElement(t){return document.getElementById(t)}hideLoading(){const t=this.getElement("imageLoading");t&&(t.style.display="none")}showLoading(){const t=this.getElement("imageLoading");t&&(t.style.display="flex")}clearImageContainer(){const t=this.getElement("imageContainer");t&&(t.innerHTML="")}addToImageContainer(t){const e=this.getElement("imageContainer");e&&t&&e.appendChild(t)}clearErrorMessages(){const t=this.getElement("errorContainer");t&&(t.innerHTML="")}showImagePlaceholder(){const t=this.getElement("imageContainer");t&&(t.innerHTML='\n                <div class="image-placeholder">\n                    <div class="placeholder-icon">ðŸ“·</div>\n                    <div class="placeholder-text">No Image Selected</div>\n                    <div class="placeholder-subtext">Click "Screenshot" to capture or "Load File" to select an image for OCR</div>\n                </div>\n            ')}displayResult(t){t.imageData&&(t.imageData.startsWith("data:")?this.displayImageFromDataUrl(t.imageData):this.displayImage(t.imageData)),t.text&&this.displayText(t.text),this.updateStatus("Recognition complete")}displayImage(t,e=null){this.currentImageData=t,this.hideLoading();const a=this.createImageElement(t,e);this.clearImageContainer(),this.addToImageContainer(a)}displayImageFromDataUrl(t){this.currentImageData=t,this.hideLoading();const e=this.createImageElementFromDataUrl(t);this.clearImageContainer(),this.addToImageContainer(e)}createImageElement(t,e=null){const a=document.createElement("img"),i=this.getMimeType(e);return a.src=`data:${i};base64,${t}`,a.className="screenshot-image",a.alt="Screenshot Preview",this.addImageEventListeners(a,"base64"),a}createImageElementFromDataUrl(t){const e=document.createElement("img");return e.src=t,e.className="screenshot-image",e.alt="Screenshot Preview",this.addImageEventListeners(e,"data URL"),e}addImageEventListeners(t,e){t.onload=()=>{},t.onerror=t=>{this.displayError("Failed to load image")}}getMimeType(t){return t&&{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",bmp:"image/bmp",tiff:"image/tiff",tif:"image/tiff"}[t.split(".").pop().toLowerCase()]||"image/png"}displayText(t){this.currentText=t;const e=this.getElement("textContent");t&&t.trim()?(e.textContent=t,e.className="text-content"):(e.textContent="No text recognized",e.className="text-content empty")}displayError(t){this.getElement("errorContainer").innerHTML=`<div class="error-message">${t}</div>`,this.updateStatus("Recognition failed")}async copyText(){if(this.currentText)try{await navigator.clipboard.writeText(this.currentText),this.updateStatus("Text copied to clipboard","copy-success"),setTimeout(()=>this.updateStatus("Ready"),2e3)}catch(t){this.updateStatus("Copy failed")}else this.updateStatus("No text to copy")}async copyImage(){if(this.currentImageData)try{const t=this.currentImageData.startsWith("data:")?this.currentImageData:`data:image/png;base64,${this.currentImageData}`,e=await fetch(t),a=await e.blob();await navigator.clipboard.write([new ClipboardItem({"image/png":a})]),this.updateStatus("Image copied to clipboard","copy-success"),setTimeout(()=>this.updateStatus("Ready"),2e3)}catch(t){this.updateStatus("Copy image failed")}else this.updateStatus("No image to copy")}async saveImage(){if(!this.currentImageData)return void this.updateStatus("No image to save");const t=await window.otools.showSaveDialog();if(t&&t.filePath)try{await window.otools.writeFile(t.filePath,`data:image/png;base64,${this.currentImageData}`),this.updateStatus("Image saved successfully","copy-success")}catch(t){this.updateStatus("Save failed")}}clearText(){this.currentText="";const t=this.getElement("textContent");t.textContent="Waiting for OCR result...",t.className="text-content empty",this.currentImageData||this.showImagePlaceholder(),this.updateStatus("Text cleared")}clearImage(){this.currentImageData=null,this.showImagePlaceholder(),this.updateStatus("Image cleared")}prepareForProcessing(){this.isProcessing=!0,this.showLoading(),this.clearImageContainer(),this.addToImageContainer(this.getElement("imageLoading")),this.resetTextContent(),this.clearErrorMessages()}resetTextContent(){const t=this.getElement("textContent");t&&(t.textContent="Waiting for OCR result...",t.className="text-content empty")}setProcessingText(t){const e=this.getElement("textContent");e&&(e.textContent=t,e.className="text-content empty")}finishProcessing(){this.isProcessing=!1}async Screenshot(){this.updateStatus("Taking screenshot..."),this.prepareForProcessing(),this.setProcessingText("Waiting for OCR result..."),window.otools.hideWindow();let t=null;try{const e=await window.otools.captureScreen();if(!e||!e.imageData)return setTimeout(()=>window.otools.showWindow(),100),this.displayError("No valid screenshot obtained"),void this.finishProcessing();if(t=e.imageData,t instanceof Uint8Array||"undefined"!=typeof Buffer&&t instanceof Buffer)if("undefined"!=typeof Buffer&&t instanceof Buffer)t=t.toString("base64");else{const e=Array.from(t,t=>String.fromCharCode(t)).join("");t=btoa(e)}"string"!=typeof t||t.startsWith("data:")||(t="data:image/png;base64,"+t),setTimeout(()=>window.otools.showWindow(),100),this.displayImageFromDataUrl(t),this.currentImageData=t,this.setProcessingText("Waiting for OCR result..."),this.updateStatus("Recognizing text...")}catch(t){return setTimeout(()=>window.otools.showWindow(),100),this.displayError("Screenshot failed: "+t.message),void this.finishProcessing()}try{const e=await window.otools.performOcr(t);e&&e.text?(this.displayText(e.text),this.updateStatus("Recognition complete")):(this.displayText(""),this.updateStatus("No text found in image"))}catch(t){this.displayError("OCR failed: "+t.message),this.updateStatus("Recognition failed")}finally{this.finishProcessing()}}async loadFileAndOcr(){try{const t=await window.otools.showOpenDialog({properties:["openFile"],filters:[{name:"Images",extensions:["jpg","jpeg","png","bmp","gif","tiff"]},{name:"All Files",extensions:["*"]}]});if(t.canceled||!t.filePaths||0===t.filePaths.length)return void this.updateStatus("File selection cancelled");const e=t.filePaths[0];this.updateStatus("Loading file..."),this.prepareForProcessing(),this.setProcessingText("Processing file...");const a=await window.otools.readFile(e);if(!a||!a.success)throw new Error("Failed to read file");const i=this.processFileData(a,e);this.displayImageFromDataUrl(i),this.currentImageData=i,this.updateStatus("Performing OCR...");const s=await window.otools.performOcr(i);s&&s.text?(this.displayText(s.text),this.updateStatus("OCR completed")):(this.displayText(""),this.updateStatus("No text found in image"))}catch(t){this.displayError("File OCR failed: "+t.message),this.updateStatus("OCR failed")}finally{this.finishProcessing()}}processFileData(t,e){if(t.content&&t.content.startsWith("data:"))return t.content;let a;if("undefined"!=typeof Buffer)a=Buffer.from(t.content||t).toString("base64");else{const e=new Uint8Array(t.content||t),i=Array.from(e,t=>String.fromCharCode(t)).join("");a=btoa(i)}return`data:${this.getMimeType(e)};base64,${a}`}updateStatus(t,e=""){const a=this.getElement("statusText");a&&(a.style.opacity="0.7",a.textContent=t,a.className=e,setTimeout(()=>{a.style.opacity="1"},150))}updateTimestamp(){const t=this.getElement("timestamp");t&&(t.textContent=(new Date).toLocaleString("en-US"))}},window.Screenshot=()=>window.ocrPlugin.Screenshot(),window.loadFileAndOcr=()=>window.ocrPlugin.loadFileAndOcr(),window.copyText=()=>window.ocrPlugin.copyText(),window.copyImage=()=>window.ocrPlugin.copyImage(),window.saveImage=()=>window.ocrPlugin.saveImage(),window.clearText=()=>window.ocrPlugin.clearText(),window.clearImage=()=>window.ocrPlugin.clearImage();