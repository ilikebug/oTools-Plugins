window.clipboard=new class{constructor(){this.POLL_INTERVAL=100,this.HISTORY_LIST_MAX=100,this.HISTORY_KEY="clipboard_history",this.FAV_KEY="clipboard_fav",this.DB_NAME="clipboard_db",this.listenerEnable=!1,this.lastUniqID=null,this.historyList=[],this.favList=[],this.showFavOnly=!1,this.init()}async init(){await this.startClipboardListener(),this.historyList=await this.getHistory(),this.favList=await this.getFavList(),this.renderHistoryList(),setInterval(()=>{this.saveHistoryList(),this.saveFavList()},5e3),this.bindSearchEvents(),this.bindFavToggleEvent()}async startClipboardListener(){this.listenerEnable||(setInterval(()=>this.checkClipboard(),this.POLL_INTERVAL),this.listenerEnable=!0)}async checkClipboard(){const t=await this.readClipboardItem();if(!t)return;const e=this.generateContentUniqID(t);e!=this.lastUniqID&&(this.lastUniqID=e,this.addContent2HistoryList(t),this.renderHistoryList())}generateContentUniqID(t){return"text"===t.type?"t_"+this.hashCode(t.data):"image"===t.type?"i_"+this.hashCode(t.data):"u_"+Date.now()}hashCode(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return e.toString(36)}addContent2HistoryList(t){this.historyList.length>=this.HISTORY_LIST_MAX&&this.historyList.shift(),this.historyList.push(t)}getHistoryList(){return this.historyList}async saveHistoryList(){await this.setHistory(this.historyList)}renderHistoryList(t){this.showFavOnly?t=[...this.favList].reverse():t||(t=[...this.historyList].reverse());const e=document.querySelector(".main-content");t&&0!==t.length?(e.innerHTML='<div class="clip-list">'+t.map((t,e)=>{const i=`<button class="clip-fav-btn ${this.isFav(t)?"fav":""}" data-index="${e}" title="Favorite">\n        <svg viewBox="0 0 20 20" fill="none" width="18" height="18" xmlns="http://www.w3.org/2000/svg">\n          <path d="M10 15l-5.09 2.67 1-5.82L2 7.97l5.91-.86L10 2.5l2.09 4.61 5.91.86-4.27 4.88 1 5.82z" stroke="#2563eb" stroke-width="1.5" fill="${this.isFav(t)?"#ffd600":"none"}"/>\n        </svg>\n      </button>`;return"text"===t.type?`<div class='clip-item' data-index='${e}'>\n          <div class='clip-content' data-fulltext="${this.escapeHtml(t.data)}">${this.escapeHtml(t.data)}</div>\n          ${i}\n        </div>`:"image"===t.type?`<div class='clip-item' data-index='${e}'>\n          <img class='clip-img' src='${t.data}' loading="lazy" />\n          ${i}\n        </div>`:`<div class='clip-item' data-index='${e}'>\n          <div class='clip-content'>[Unknown type]</div>\n          ${i}\n        </div>`}).join("")+"</div>",e.querySelectorAll(".clip-item").forEach(e=>{e.onclick=async i=>{if(i.target.closest(".clip-fav-btn"))return;const s=e.getAttribute("data-index"),a=t[s];await this.copyToClipboard(a),await window.otools.hideWindow(),setTimeout(()=>this.paste(),100)}}),e.querySelectorAll(".clip-fav-btn").forEach(e=>{e.onclick=i=>{i.stopPropagation();const s=e.getAttribute("data-index"),a=t[s];this.isFav(a)?this.removeFromFav(a):this.addToFav(a),this.renderHistoryList(t)}}),this.bindKeyboardNavigation(t),e.querySelectorAll(".clip-content").forEach(t=>{t.addEventListener("mouseenter",e=>{t.style.maxHeight="none",t.style.webkitLineClamp="unset",t.style.overflow="visible"}),t.addEventListener("mouseleave",e=>{t.style.maxHeight="60px",t.style.webkitLineClamp=3,t.style.overflow="hidden"})})):e.innerHTML='<div class="empty">No clipboard history.</div>'}bindKeyboardNavigation(t){this._keydownHandler&&document.removeEventListener("keydown",this._keydownHandler);let e=0;const i=document.querySelectorAll(".clip-item");0!==i.length&&(i.forEach((t,i)=>{t.classList.toggle("selected",i===e)}),this._keydownHandler=s=>{if("Tab"===s.key&&"INPUT"!==document.activeElement.tagName){s.preventDefault(),this.showFavOnly=!this.showFavOnly;const t=document.querySelector(".fav-toggle-btn");t&&t.classList.toggle("active",this.showFavOnly);const e=document.querySelector(".top-bar input");return e&&(e.value=""),void this.renderHistoryList()}if("ArrowDown"===s.key)e=(e+1)%i.length,i.forEach((t,i)=>{t.classList.toggle("selected",i===e)}),i[e].scrollIntoView({block:"nearest"}),s.preventDefault();else if("ArrowUp"===s.key)e=(e-1+i.length)%i.length,i.forEach((t,i)=>{t.classList.toggle("selected",i===e)}),i[e].scrollIntoView({block:"nearest"}),s.preventDefault();else if("Enter"===s.key){const i=t[e];this.copyToClipboard(i),window.otools.hideWindow(),s.preventDefault(),setTimeout(()=>this.paste(),100)}},document.addEventListener("keydown",this._keydownHandler))}bindFavToggleEvent(){const t=document.querySelector(".fav-toggle-btn");t&&(t.onclick=()=>{this.showFavOnly=!this.showFavOnly,t.classList.toggle("active",this.showFavOnly);const e=document.querySelector(".top-bar input");e&&(e.value=""),this.renderHistoryList()})}bindSearchEvents(){const t=document.querySelector(".top-bar input");t&&t.addEventListener("input",()=>{const e=t.value;""===e?this.renderHistoryList():this.handleSearch(e)})}handleSearch(t){if(!(t=t.trim().toLowerCase()))return void this.renderHistoryList();const e=this.historyList.filter(e=>"text"===e.type&&e.data.toLowerCase().includes(t));this.renderHistoryList(e)}escapeHtml(t){return t?t.replace(/[&<>"']/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]||t}):""}async getHistory(){const t=await window.otools.getDbValue(this.DB_NAME,this.HISTORY_KEY);return t&&t.success&&t.value?t.value:[]}async setHistory(t){await window.otools.setDbValue(this.DB_NAME,this.HISTORY_KEY,t)}async readClipboardItem(){const t=await window.otools.readClipboard();if(t&&t.success)return{type:"text",data:t.text};const e=await window.otools.readClipboardImage();return e&&e.success?{type:"image",data:e.imageData}:null}async copyToClipboard(t){"text"===t.type?await window.otools.writeClipboard(t.data):"image"===t.type&&await window.otools.writeClipboardImage(t.data)}async paste(){const t=await window.otools.getMousePosition();t&&t.success&&await window.otools.simulateMouse("click",{x:t.x,y:t.y,button:"left"});let e=["command"];"win32"!==window.plugin.getplatformName()&&"linux"!==window.plugin.getplatformName()||(e=["control"]),setTimeout(()=>{window.otools.simulateKeyboard("keyTap",{key:"v",modifiers:e})},100)}async getFavList(){const t=await window.otools.getDbValue(this.DB_NAME,this.FAV_KEY);return t&&t.success&&t.value?t.value:[]}async saveFavList(){await window.otools.setDbValue(this.DB_NAME,this.FAV_KEY,this.favList)}addToFav(t){const e=this.generateContentUniqID(t);this.favList.find(t=>this.generateContentUniqID(t)===e)||this.favList.push(t)}removeFromFav(t){const e=this.generateContentUniqID(t);this.favList=this.favList.filter(t=>this.generateContentUniqID(t)!==e)}isFav(t){const e=this.generateContentUniqID(t);return this.favList.some(t=>this.generateContentUniqID(t)===e)}};